from fractions import Fraction

from bitarray import bitarray
from iscc_sdk import mp7
import iscc_sdk as idk


def test_calc_byte_to_bit3():
    assert mp7.calc_byte_to_bit3().tolist() == [
        [0, 0, 0, 0, 0],
        [0, 0, 0, 0, 1],
        [0, 0, 0, 0, 2],
        [0, 0, 0, 1, 0],
        [0, 0, 0, 1, 1],
        [0, 0, 0, 1, 2],
        [0, 0, 0, 2, 0],
        [0, 0, 0, 2, 1],
        [0, 0, 0, 2, 2],
        [0, 0, 1, 0, 0],
        [0, 0, 1, 0, 1],
        [0, 0, 1, 0, 2],
        [0, 0, 1, 1, 0],
        [0, 0, 1, 1, 1],
        [0, 0, 1, 1, 2],
        [0, 0, 1, 2, 0],
        [0, 0, 1, 2, 1],
        [0, 0, 1, 2, 2],
        [0, 0, 2, 0, 0],
        [0, 0, 2, 0, 1],
        [0, 0, 2, 0, 2],
        [0, 0, 2, 1, 0],
        [0, 0, 2, 1, 1],
        [0, 0, 2, 1, 2],
        [0, 0, 2, 2, 0],
        [0, 0, 2, 2, 1],
        [0, 0, 2, 2, 2],
        [0, 1, 0, 0, 0],
        [0, 1, 0, 0, 1],
        [0, 1, 0, 0, 2],
        [0, 1, 0, 1, 0],
        [0, 1, 0, 1, 1],
        [0, 1, 0, 1, 2],
        [0, 1, 0, 2, 0],
        [0, 1, 0, 2, 1],
        [0, 1, 0, 2, 2],
        [0, 1, 1, 0, 0],
        [0, 1, 1, 0, 1],
        [0, 1, 1, 0, 2],
        [0, 1, 1, 1, 0],
        [0, 1, 1, 1, 1],
        [0, 1, 1, 1, 2],
        [0, 1, 1, 2, 0],
        [0, 1, 1, 2, 1],
        [0, 1, 1, 2, 2],
        [0, 1, 2, 0, 0],
        [0, 1, 2, 0, 1],
        [0, 1, 2, 0, 2],
        [0, 1, 2, 1, 0],
        [0, 1, 2, 1, 1],
        [0, 1, 2, 1, 2],
        [0, 1, 2, 2, 0],
        [0, 1, 2, 2, 1],
        [0, 1, 2, 2, 2],
        [0, 2, 0, 0, 0],
        [0, 2, 0, 0, 1],
        [0, 2, 0, 0, 2],
        [0, 2, 0, 1, 0],
        [0, 2, 0, 1, 1],
        [0, 2, 0, 1, 2],
        [0, 2, 0, 2, 0],
        [0, 2, 0, 2, 1],
        [0, 2, 0, 2, 2],
        [0, 2, 1, 0, 0],
        [0, 2, 1, 0, 1],
        [0, 2, 1, 0, 2],
        [0, 2, 1, 1, 0],
        [0, 2, 1, 1, 1],
        [0, 2, 1, 1, 2],
        [0, 2, 1, 2, 0],
        [0, 2, 1, 2, 1],
        [0, 2, 1, 2, 2],
        [0, 2, 2, 0, 0],
        [0, 2, 2, 0, 1],
        [0, 2, 2, 0, 2],
        [0, 2, 2, 1, 0],
        [0, 2, 2, 1, 1],
        [0, 2, 2, 1, 2],
        [0, 2, 2, 2, 0],
        [0, 2, 2, 2, 1],
        [0, 2, 2, 2, 2],
        [1, 0, 0, 0, 0],
        [1, 0, 0, 0, 1],
        [1, 0, 0, 0, 2],
        [1, 0, 0, 1, 0],
        [1, 0, 0, 1, 1],
        [1, 0, 0, 1, 2],
        [1, 0, 0, 2, 0],
        [1, 0, 0, 2, 1],
        [1, 0, 0, 2, 2],
        [1, 0, 1, 0, 0],
        [1, 0, 1, 0, 1],
        [1, 0, 1, 0, 2],
        [1, 0, 1, 1, 0],
        [1, 0, 1, 1, 1],
        [1, 0, 1, 1, 2],
        [1, 0, 1, 2, 0],
        [1, 0, 1, 2, 1],
        [1, 0, 1, 2, 2],
        [1, 0, 2, 0, 0],
        [1, 0, 2, 0, 1],
        [1, 0, 2, 0, 2],
        [1, 0, 2, 1, 0],
        [1, 0, 2, 1, 1],
        [1, 0, 2, 1, 2],
        [1, 0, 2, 2, 0],
        [1, 0, 2, 2, 1],
        [1, 0, 2, 2, 2],
        [1, 1, 0, 0, 0],
        [1, 1, 0, 0, 1],
        [1, 1, 0, 0, 2],
        [1, 1, 0, 1, 0],
        [1, 1, 0, 1, 1],
        [1, 1, 0, 1, 2],
        [1, 1, 0, 2, 0],
        [1, 1, 0, 2, 1],
        [1, 1, 0, 2, 2],
        [1, 1, 1, 0, 0],
        [1, 1, 1, 0, 1],
        [1, 1, 1, 0, 2],
        [1, 1, 1, 1, 0],
        [1, 1, 1, 1, 1],
        [1, 1, 1, 1, 2],
        [1, 1, 1, 2, 0],
        [1, 1, 1, 2, 1],
        [1, 1, 1, 2, 2],
        [1, 1, 2, 0, 0],
        [1, 1, 2, 0, 1],
        [1, 1, 2, 0, 2],
        [1, 1, 2, 1, 0],
        [1, 1, 2, 1, 1],
        [1, 1, 2, 1, 2],
        [1, 1, 2, 2, 0],
        [1, 1, 2, 2, 1],
        [1, 1, 2, 2, 2],
        [1, 2, 0, 0, 0],
        [1, 2, 0, 0, 1],
        [1, 2, 0, 0, 2],
        [1, 2, 0, 1, 0],
        [1, 2, 0, 1, 1],
        [1, 2, 0, 1, 2],
        [1, 2, 0, 2, 0],
        [1, 2, 0, 2, 1],
        [1, 2, 0, 2, 2],
        [1, 2, 1, 0, 0],
        [1, 2, 1, 0, 1],
        [1, 2, 1, 0, 2],
        [1, 2, 1, 1, 0],
        [1, 2, 1, 1, 1],
        [1, 2, 1, 1, 2],
        [1, 2, 1, 2, 0],
        [1, 2, 1, 2, 1],
        [1, 2, 1, 2, 2],
        [1, 2, 2, 0, 0],
        [1, 2, 2, 0, 1],
        [1, 2, 2, 0, 2],
        [1, 2, 2, 1, 0],
        [1, 2, 2, 1, 1],
        [1, 2, 2, 1, 2],
        [1, 2, 2, 2, 0],
        [1, 2, 2, 2, 1],
        [1, 2, 2, 2, 2],
        [2, 0, 0, 0, 0],
        [2, 0, 0, 0, 1],
        [2, 0, 0, 0, 2],
        [2, 0, 0, 1, 0],
        [2, 0, 0, 1, 1],
        [2, 0, 0, 1, 2],
        [2, 0, 0, 2, 0],
        [2, 0, 0, 2, 1],
        [2, 0, 0, 2, 2],
        [2, 0, 1, 0, 0],
        [2, 0, 1, 0, 1],
        [2, 0, 1, 0, 2],
        [2, 0, 1, 1, 0],
        [2, 0, 1, 1, 1],
        [2, 0, 1, 1, 2],
        [2, 0, 1, 2, 0],
        [2, 0, 1, 2, 1],
        [2, 0, 1, 2, 2],
        [2, 0, 2, 0, 0],
        [2, 0, 2, 0, 1],
        [2, 0, 2, 0, 2],
        [2, 0, 2, 1, 0],
        [2, 0, 2, 1, 1],
        [2, 0, 2, 1, 2],
        [2, 0, 2, 2, 0],
        [2, 0, 2, 2, 1],
        [2, 0, 2, 2, 2],
        [2, 1, 0, 0, 0],
        [2, 1, 0, 0, 1],
        [2, 1, 0, 0, 2],
        [2, 1, 0, 1, 0],
        [2, 1, 0, 1, 1],
        [2, 1, 0, 1, 2],
        [2, 1, 0, 2, 0],
        [2, 1, 0, 2, 1],
        [2, 1, 0, 2, 2],
        [2, 1, 1, 0, 0],
        [2, 1, 1, 0, 1],
        [2, 1, 1, 0, 2],
        [2, 1, 1, 1, 0],
        [2, 1, 1, 1, 1],
        [2, 1, 1, 1, 2],
        [2, 1, 1, 2, 0],
        [2, 1, 1, 2, 1],
        [2, 1, 1, 2, 2],
        [2, 1, 2, 0, 0],
        [2, 1, 2, 0, 1],
        [2, 1, 2, 0, 2],
        [2, 1, 2, 1, 0],
        [2, 1, 2, 1, 1],
        [2, 1, 2, 1, 2],
        [2, 1, 2, 2, 0],
        [2, 1, 2, 2, 1],
        [2, 1, 2, 2, 2],
        [2, 2, 0, 0, 0],
        [2, 2, 0, 0, 1],
        [2, 2, 0, 0, 2],
        [2, 2, 0, 1, 0],
        [2, 2, 0, 1, 1],
        [2, 2, 0, 1, 2],
        [2, 2, 0, 2, 0],
        [2, 2, 0, 2, 1],
        [2, 2, 0, 2, 2],
        [2, 2, 1, 0, 0],
        [2, 2, 1, 0, 1],
        [2, 2, 1, 0, 2],
        [2, 2, 1, 1, 0],
        [2, 2, 1, 1, 1],
        [2, 2, 1, 1, 2],
        [2, 2, 1, 2, 0],
        [2, 2, 1, 2, 1],
        [2, 2, 1, 2, 2],
        [2, 2, 2, 0, 0],
        [2, 2, 2, 0, 1],
        [2, 2, 2, 0, 2],
        [2, 2, 2, 1, 0],
        [2, 2, 2, 1, 1],
        [2, 2, 2, 1, 2],
        [2, 2, 2, 2, 0],
        [2, 2, 2, 2, 1],
        [2, 2, 2, 2, 2],
        [0, 0, 0, 0, 0],
        [0, 0, 0, 0, 1],
        [0, 0, 0, 0, 2],
        [0, 0, 0, 1, 0],
        [0, 0, 0, 1, 1],
        [0, 0, 0, 1, 2],
        [0, 0, 0, 2, 0],
        [0, 0, 0, 2, 1],
        [0, 0, 0, 2, 2],
        [0, 0, 1, 0, 0],
        [0, 0, 1, 0, 1],
        [0, 0, 1, 0, 2],
        [0, 0, 1, 1, 0],
    ]


def test_pop_bits():
    data = bitarray("1010101010101010")
    assert mp7.pop_bits(data, 4, 8) == (170, 12)


def test_read_mp7_signature(mp4_file):
    sig = idk.video_mp7sig_extract(mp4_file)
    result = idk.read_mp7_signature(sig)
    frame = result[-1]
    assert isinstance(frame, mp7.Frame)
    assert frame.confidence == 77
    assert frame.elapsed == Fraction(299, 5)
    assert frame.vector.tolist() == [
        0,
        0,
        1,
        1,
        0,
        0,
        1,
        0,
        1,
        0,
        0,
        0,
        1,
        0,
        0,
        0,
        1,
        1,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        1,
        0,
        0,
        0,
        1,
        1,
        0,
        1,
        1,
        2,
        2,
        1,
        1,
        1,
        2,
        2,
        2,
        2,
        2,
        2,
        0,
        0,
        2,
        1,
        1,
        0,
        1,
        1,
        1,
        1,
        1,
        2,
        2,
        2,
        0,
        2,
        2,
        2,
        0,
        0,
        0,
        0,
        0,
        1,
        2,
        2,
        1,
        0,
        2,
        1,
        1,
        2,
        2,
        1,
        1,
        2,
        1,
        1,
        2,
        0,
        1,
        1,
        0,
        2,
        2,
        1,
        1,
        1,
        2,
        1,
        1,
        1,
        0,
        2,
        0,
        0,
        0,
        2,
        2,
        2,
        0,
        2,
        1,
        2,
        2,
        2,
        0,
        0,
        0,
        1,
        2,
        1,
        1,
        1,
        1,
        1,
        2,
        0,
        1,
        0,
        2,
        0,
        0,
        2,
        2,
        1,
        1,
        0,
        0,
        2,
        2,
        2,
        2,
        1,
        2,
        0,
        0,
        2,
        2,
        0,
        2,
        2,
        2,
        2,
        0,
        1,
        0,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        1,
        1,
        1,
        2,
        0,
        0,
        0,
        0,
        0,
        2,
        1,
        2,
        0,
        1,
        1,
        1,
        1,
        0,
        1,
        2,
        2,
        2,
        1,
        1,
        0,
        1,
        2,
        2,
        2,
        1,
        0,
        0,
        2,
        2,
        2,
        1,
        1,
        2,
        2,
        2,
        1,
        2,
        2,
        2,
        2,
        2,
        2,
        0,
        1,
        2,
        0,
        0,
        2,
        2,
        1,
        0,
        2,
        0,
        0,
        2,
        1,
        0,
        2,
        2,
        2,
        1,
        1,
        1,
        1,
        1,
        2,
        0,
        0,
        2,
        2,
        2,
        1,
        2,
        1,
        1,
        0,
        1,
        1,
        2,
        0,
        1,
        1,
        0,
        1,
        1,
        0,
        2,
        1,
        1,
        0,
        0,
        1,
        2,
        2,
        2,
        0,
        0,
        1,
        2,
        2,
        0,
        2,
        0,
        0,
        0,
        2,
        2,
        0,
        2,
        2,
        0,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        1,
        0,
        1,
        1,
        0,
        2,
        2,
        2,
        0,
        2,
        1,
        0,
        1,
        1,
        2,
        1,
        2,
        0,
        1,
        0,
        2,
        1,
        0,
        0,
        0,
        1,
        0,
        1,
        0,
        1,
        1,
        0,
        2,
        1,
        0,
        1,
        1,
        0,
        0,
        0,
        2,
        0,
        2,
        1,
        0,
        0,
        2,
        2,
        2,
        2,
        2,
        2,
        0,
        1,
        2,
        2,
        0,
        1,
        1,
        0,
        2,
        1,
        0,
        1,
        2,
        0,
        1,
        1,
        1,
        2,
        2,
        1,
        0,
        0,
        2,
        1,
        1,
        2,
        0,
        1,
        0,
        2,
        1,
        0,
        2,
        2,
        2,
        0,
        1,
        1,
        1,
        1,
        2,
        1,
        2,
        0,
        2,
        2,
    ]
